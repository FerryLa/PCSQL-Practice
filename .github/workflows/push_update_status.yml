name: Update Daily Status on Push

on:
  push:
    branches: ['feature/**', 'develop']
    paths:
      - '**/solutions/**'
      - '.github/workflows/push_update_status.yml'   # ì›Œí¬í”Œë¡œ ìˆ˜ì • í…ŒìŠ¤íŠ¸ ìš©(ì›ì¹˜ ì•Šìœ¼ë©´ ì§€ì›Œë„ ë¨)

permissions:
  contents: write
  pull-requests: write

jobs:
  mark:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
      README_PATH: 01_cert_week_7/README.md
    steps:
      # HEAD~1ê³¼ ë¹„êµí•˜ë ¤ë©´ ìµœì†Œ 2ê°œ ì»¤ë°‹ì´ í•„ìš”
      - name: Checkout current ref
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 2

      # í‘œ ê°±ì‹ 
      - name: Update README table (âœ…/â° auto mark)
        uses: actions/github-script@v7
        env:
          README_PATH: ${{ env.README_PATH }}
        with:
          script: |
            const fs = require('fs');
            const path = process.env.README_PATH;

            if (!fs.existsSync(path)) { core.warning(`Skip: ${path} not found`); return; }

            let md = fs.readFileSync(path, 'utf8');
            const S = '<!-- PROGRESS:START -->';
            const E = '<!-- PROGRESS:END -->';
            const si = md.indexOf(S), ei = md.indexOf(E);
            if (si < 0 || ei < 0) { core.warning('Skip: markers missing'); return; }

            // ë¸”ë¡ ì¶”ì¶œ (ë§ˆì»¤ ì‚¬ì´)
            const before = md.slice(0, si + S.length);
            let   block  = md.slice(si + S.length, ei);
            const after  = md.slice(ei);

            // ê¸°ì¡´ í–‰ë§Œ ë½‘ê¸°(í—¤ë”/êµ¬ë¶„ì„  ì œê±°)
            const rawLines = block.split('\n')
              .map(s => s.trim())
              .filter(s => s && !/^(\| *Date *\| *Status *\| *Note *\|?)$/.test(s) && !/^(\|-{2,}\|[-| ]*?)$/.test(s));

            // ë³€ê²½ íŒŒì¼ì—ì„œ ë‚ ì§œ ì°¾ê¸° + git diff fallback
            const commits = Array.isArray(context.payload.commits) ? context.payload.commits : [];
            const changedPaths = [];
            for (const c of commits) {
              const add = Array.isArray(c.added)?c.added:[], mod = Array.isArray(c.modified)?c.modified:[], rem = Array.isArray(c.removed)?c.removed:[];
              for (const p of [...add, ...mod, ...rem]) changedPaths.push(p);
            }
            if (changedPaths.length === 0) {
              try {
                const { execSync } = require('child_process');
                const out = execSync('git diff --name-only HEAD~1 HEAD', { encoding: 'utf8' });
                out.split('\n').filter(Boolean).forEach(p => changedPaths.push(p));
                core.info('Used git diff fallback for changed paths.');
              } catch {}
            }
            const re = /(?:^|\/)solutions\/(\d{4})\/(\d{2})\/(\d{2})\//;
            const dateSet = new Set();
            for (const f of changedPaths) {
              const m = typeof f === 'string' ? f.match(re) : null;
              if (m) dateSet.add(`${m[1]}-${m[2]}-${m[3]}`);
            }

            // ì˜¤ëŠ˜/ì–´ì œ í´ë”ê°€ ì‹¤ì œ ìˆìœ¼ë©´ í›„ë³´ì— ì¶”ê°€(í‘¸ì‹œ ì—†ì´ ìˆ˜ë™ íŒŒì¼ ì¶”ê°€/ì´ë™ ëŒ€ë¹„)
            const nowKST = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
            const z = n => String(n).padStart(2,'0');
            const today = `${nowKST.getFullYear()}-${z(nowKST.getMonth()+1)}-${z(nowKST.getDate())}`;
            const yObj = new Date(nowKST); yObj.setDate(yObj.getDate()-1);
            const yesterday = `${yObj.getFullYear()}-${z(yObj.getMonth()+1)}-${z(yObj.getDate())}`;

            const rootDir = path.replace(/\/README\.md$/, '');
            const solRoot = `${rootDir}/solutions`;
            const dirFor = (d) => { const [Y,M,D] = d.split('-'); return `${solRoot}/${Y}/${M}/${D}`; };
            try {
              if (!dateSet.size) {
                if (fs.existsSync(dirFor(today)))     dateSet.add(today);
                if (fs.existsSync(dirFor(yesterday))) dateSet.add(yesterday);
              }
            } catch {}

            if (dateSet.size === 0) { core.info('No solution-date found. Skip.'); return; }

            // ë§ˆí‚¹ ê·œì¹™
            const hour = nowKST.getHours();
            const isEmpty = s => ['','â¬œ','ğŸŸª'].includes(String(s).trim());
            const wantMark = (date) => {
              if (date === today) return 'âœ…';
              if (date === yesterday && hour < 6) return 'â°';
              return null;
            };

            // ê¸°ì¡´ í–‰ ì¸ë±ìŠ¤ ë§µ(date -> idx)
            const rowIdx = new Map();
            rawLines.forEach((line, i) => {
              const m = line.match(/^\s*\|\s*(\d{4}-\d{2}-\d{2})\s*\|\s*([^|]*)\|\s*(.*)\|?\s*$/);
              if (m) rowIdx.set(m[1], i);
            });

            let lines = [...rawLines];
            let changed = false;

            for (const date of dateSet) {
              const mark = wantMark(date);
              if (!mark) continue;

              if (rowIdx.has(date)) {
                const i = rowIdx.get(date);
                const m = lines[i].match(/^\s*\|\s*(\d{4}-\d{2}-\d{2})\s*\|\s*([^|]*)\|\s*(.*)\|?\s*$/);
                const status = m ? m[2] : '';
                const rest   = m ? (m[3] || '').replace(/\|+\s*$/, '').trim() : '';
                if (isEmpty(status)) {
                  lines[i] = `| ${date} | ${mark} | ${rest} |`;
                  changed = true;
                }
              } else {
                // ìƒˆ ë‚ ì§œëŠ” ìµœìƒë‹¨ì— ì‚½ì…(ìµœê·¼ì¼ì´ ìœ„ìª½)
                lines.unshift(`| ${date} | ${mark} | |`);
                changed = true;
              }
            }

            if (!changed) { core.info('No table changes needed.'); return; }

            // í‘œëŠ” í•­ìƒ ë§ˆì»¤ ë¸”ë¡ ì•ˆì— "í—¤ë” + êµ¬ë¶„ì„  + ë°ì´í„°"ë¥¼ í†µì§¸ë¡œ ì“´ë‹¤
            const header = '| Date       | Status | Note |\n|------------|--------|------|';
            block = '\n' + header + '\n' + lines.join('\n') + '\n';

            const out = before + block + after;
            fs.writeFileSync(path, out, 'utf8');
            core.info(`Updated ${path} for dates: ${[...dateSet].join(', ')}`);

      # feature/* ì—ì„œëŠ” í˜„ì¬ ë¸Œëœì¹˜ë¡œ ì»¤ë°‹
      - name: Commit to feature branch
        if: startsWith(github.ref_name, 'feature/')
        run: |
          git config user.name "actions-bot"
          git config user.email "actions@users.noreply.github.com"
          git add "${{ env.README_PATH }}"
          git diff --cached --quiet || git commit -m "chore: mark daily status"
          git push origin HEAD:${{ github.ref_name }}

      # develop ì—ì„œëŠ” PRë§Œ ìƒì„±(ë³´í˜¸ ë¸Œëœì¹˜ ì¤€ìˆ˜)
      - name: Create PR to develop
        if: github.ref_name == 'develop'
        uses: peter-evans/create-pull-request@v6
        with:
          base: develop
          branch: automation/readme-progress
          title: "chore: update README progress (push trigger)"
          commit-message: "chore: update README progress (push trigger)"
          add-paths: |
            ${{ env.README_PATH }}

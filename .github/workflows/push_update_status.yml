name: Update Daily Status on Push

on:
  push:
    branches: ['feature/**', 'develop']
    paths:
      - '**/solutions/**'
      # ì›Œí¬í”Œë¡œ íŒŒì¼ë§Œ ê³ ì³ë„ í…ŒìŠ¤íŠ¸í•˜ê³  ì‹¶ìœ¼ë©´ ìœ ì§€, ì•„ë‹ˆë©´ ì´ ì¤„ ì§€ì›Œë¼
      - '.github/workflows/push_update_status.yml'

permissions:
  contents: write
  pull-requests: write

jobs:
  mark:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
      START_DATE: '2025-10-02'
      END_DATE:   '2025-11-21'
      README_PATH: 01_cert_week_7/README.md

    steps:
      # HEAD~1ê³¼ ë¹„êµí•˜ë ¤ë©´ ìµœì†Œ 2ê°œ ì»¤ë°‹ì„ ê°€ì ¸ì™€ì•¼ í•œë‹¤
      - name: Checkout current ref
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 2

      # â”€â”€ ë””ë²„ê·¸ 1: ì»¨í…ìŠ¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Debug context
        run: |
          echo "branch=${GITHUB_REF_NAME}"
          echo "repo=${GITHUB_REPOSITORY}"
          echo "readme=${README_PATH}"
          if [ -f "${README_PATH}" ]; then
            echo "README exists âœ…"
          else
            echo "README missing âŒ"
            exit 0
          fi

      # â”€â”€ ë””ë²„ê·¸ 2: ë§ˆì»¤ ì¡´ì¬ í™•ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Check progress markers
        run: |
          if grep -q "<!-- PROGRESS:START -->" "${README_PATH}"; then
            echo "Markers found."
          else
            echo "No markers. Skip."
            exit 0
          fi

      # â”€â”€ ë””ë²„ê·¸ 3: ë³€ê²½ íŒŒì¼ ëª©ë¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Show changed files in push
        run: |
          git diff --name-only HEAD~1 HEAD || true

      # â”€â”€ ì‹¤ì œ ê°±ì‹  ë¡œì§ (âœ…/â° ìë™ ë°˜ì˜) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Update README table (auto mark âœ…/â°)
        uses: actions/github-script@v7
        env:
          README_PATH: ${{ env.README_PATH }}
          START_DATE: ${{ env.START_DATE }}
          END_DATE: ${{ env.END_DATE }}
        with:
          script: |
            const fs = require('fs');   // core, github, contextëŠ” github-scriptê°€ ì „ì—­ ì œê³µ
            const { execSync } = require('child_process');
            const path = process.env.README_PATH;

            // 0) íŒŒì¼/ë§ˆì»¤ í™•ì¸
            if (!fs.existsSync(path)) { core.warning(`Skip: ${path} not found`); return; }
            let md = fs.readFileSync(path, 'utf8');
            const S='<!-- PROGRESS:START -->', E='<!-- PROGRESS:END -->';
            const si=md.indexOf(S), ei=md.indexOf(E);
            if (si<0 || ei<0) { core.warning(`Skip: progress markers missing in ${path}`); return; }

            // 1) ë³€ê²½ íŒŒì¼ ìˆ˜ì§‘: payload ìš°ì„ , ë¹„ë©´ git diff í´ë°±
            const commits = Array.isArray(context.payload.commits) ? context.payload.commits : [];
            const changedPaths = [];
            for (const c of commits) {
              const add = Array.isArray(c.added)    ? c.added    : [];
              const mod = Array.isArray(c.modified) ? c.modified : [];
              const del = Array.isArray(c.removed)  ? c.removed  : [];
              for (const p of [...add, ...mod, ...del]) changedPaths.push(p);
            }
            if (changedPaths.length === 0) {
              try {
                const out = execSync('git diff --name-only HEAD~1 HEAD', { encoding: 'utf8' });
                out.split('\n').filter(Boolean).forEach(p => changedPaths.push(p));
                core.info('Used git diff fallback for changed paths.');
              } catch (e) {
                core.warning('git diff fallback failed: ' + e.message);  // â† warning ì² ì ê³ ì¹¨
              }
            }

            // 1-1) solutions/YYYY/MM/DD/ ë‚ ì§œ ë½‘ê¸°
            const dateSet = new Set();
            const re = /(?:^|\/)solutions\/(\d{4})\/(\d{2})\/(\d{2})\//;
            for (const f of changedPaths) {
              const m = typeof f === 'string' ? f.match(re) : null;
              if (m) dateSet.add(`${m[1]}-${m[2]}-${m[3]}`);
            }
            if (dateSet.size === 0) { core.info('No solution-date found in changed paths. Skip.'); return; }

            // 2) ì˜¤ëŠ˜/ì–´ì œ(KST)
            const nowKST = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
            const z = n => String(n).padStart(2,'0');
            const today = `${nowKST.getFullYear()}-${z(nowKST.getMonth()+1)}-${z(nowKST.getDate())}`;
            const yObj = new Date(nowKST); yObj.setDate(yObj.getDate()-1);
            const yesterday = `${yObj.getFullYear()}-${z(yObj.getMonth()+1)}-${z(yObj.getDate())}`;
            const hour = nowKST.getHours();

            // 3) í‘œ ë¸”ë¡ë§Œ ìˆ˜ì •
            const before = md.slice(0, si + S.length);
            const block  = md.slice(si + S.length, ei);
            const after  = md.slice(ei);

            const EMPTY = new Set(['', 'â¬œ', 'ğŸŸª']);   // â† ë³´ë¼ ë„¤ëª¨ë„ ë¹ˆ ì¹¸ ì·¨ê¸‰
            let changedFlag = false;
            
            const linesUpd = block.split('\n').map(line => {
              const m = line.match(/^\s*\|\s*(\d{4}-\d{2}-\d{2})\s*\|\s*([^|]*)\|\s*(.*)\|?\s*$/);
              if (!m) return line;
              const [, date, statusRaw, rest] = m;
              const status = statusRaw.trim();

              if (!dateSet.has(date)) return line;

              let mark = null;
              if (date === today) mark = 'âœ…';
              else if (date === yesterday && hour < 6) mark = 'â°';

              if (!mark) return line;
              if (status === '' || status === 'â¬œ') {
                changedFlag = true;
                return `| ${date} | ${mark} | ${rest} |`;
              }
              return line;
            });

            if (!changedFlag) { core.info('No table changes needed.'); return; }

            const out = before + '\n' + linesUpd.join('\n').replace(/^\n+/, '') + after;
            fs.writeFileSync(path, out, 'utf8');
            core.info(`Updated ${path} for dates: ${[...dateSet].join(', ')}`);

      # feature/* ì—ì„œëŠ” í˜„ì¬ ë¸Œëœì¹˜ì— ì»¤ë°‹
      - name: Commit to feature branch
        if: startsWith(github.ref_name, 'feature/')
        run: |
          git config user.name "actions-bot"
          git config user.email "actions@users.noreply.github.com"
          git add "${{ env.README_PATH }}"
          git diff --cached --quiet || git commit -m "chore: mark daily status"
          git push origin HEAD:${{ github.ref_name }}

      # develop ì—ì„œëŠ” PRë§Œ
      - name: Create PR to develop
        if: github.ref_name == 'develop'
        uses: peter-evans/create-pull-request@v6
        with:
          base: develop
          branch: automation/readme-progress
          title: "chore: update README progress (push trigger)"
          commit-message: "chore: update README progress (push trigger)"
          add-paths: |
            ${{ env.README_PATH }}

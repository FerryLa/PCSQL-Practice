name: Daily Close (mark all past blanks as âŒ)

on:
  schedule:
    - cron: '5 15 * * *'   # ë§¤ì¼ 00:05 KST (UTC+9 â†’ 15:05 UTC)
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  close:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
      README_PATH: 01_cert_week_7/README.md   # ë„ˆì˜ README ê²½ë¡œ
      START_DATE: ''                           # ì˜ˆ: '2025-10-01' ë„£ìœ¼ë©´ ê·¸ ì´í›„ë§Œ ë§ˆê°. ë¹„ìš°ë©´ ì „ì²´ ê³¼ê±°
    steps:
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: refs/heads/develop
          fetch-depth: 2

      - name: Mark âŒ for all past empty cells (incl. ğŸŸª)
        uses: actions/github-script@v7
        env:
          README_PATH: ${{ env.README_PATH }}
          START_DATE: ${{ env.START_DATE }}
        with:
          script: |
            const fs = require('fs'); // core, github, context ì „ì—­ ì œê³µ
            const path = process.env.README_PATH;
            if (!fs.existsSync(path)) { core.setFailed(`README not found: ${path}`); return; }

            let md = fs.readFileSync(path, 'utf8');
            const S = '<!-- PROGRESS:START -->';
            const E = '<!-- PROGRESS:END -->';
            const si = md.indexOf(S), ei = md.indexOf(E);
            if (si < 0 || ei < 0) { core.setFailed('Progress markers not found'); return; }

            const before = md.slice(0, si + S.length);
            let   block  = md.slice(si + S.length, ei);
            const after  = md.slice(ei);

            // ë¸”ë¡ ì•ˆì—ì„œ ê¸°ì¡´ í–‰ë§Œ ì¶”ì¶œ(í—¤ë”/êµ¬ë¶„ì„  ì œê±°)
            let lines = block.split('\n')
              .map(s => s.trim())
              .filter(Boolean);

            // í˜¹ì‹œ ì´ì „ì— í—¤ë”ê°€ ë“¤ì–´ìˆë‹¤ë©´ ì œê±°
            const isHeader = (s) => /^\|\s*Date\s*\|\s*Status\s*\|\s*Note\s*\|?$/.test(s);
            const isDivider = (s) => /^\|[-\s|]+\|$/.test(s);
            lines = lines.filter(s => !(isHeader(s) || isDivider(s)));

            // ë‚ ì§œ íŒŒì„œ (KST ê¸°ì¤€)
            const kstNow = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
            const z = n => String(n).padStart(2,'0');
            const todayStr = `${kstNow.getFullYear()}-${z(kstNow.getMonth()+1)}-${z(kstNow.getDate())}`;

            const toDate = (yyyy_mm_dd) => {
              const [Y,M,D] = yyyy_mm_dd.split('-').map(x => parseInt(x,10));
              // í˜„ì§€ ì‹œê°„ìœ¼ë¡œ ìƒì„±(ë‹¨ìˆœ ë¹„êµìš©)
              return new Date(Y, M-1, D, 0, 0, 0);
            };
            const startDateStr = (process.env.START_DATE || '').trim();
            const hasStartFloor = !!startDateStr;
            const startFloor = hasStartFloor ? toDate(startDateStr) : null;
            const today = toDate(todayStr);

            const isEmpty = (s) => {
              const t = String(s || '').trim();
              return t === '' || t === 'â¬œ' || t === 'ğŸŸª';
            };

            // ê° í–‰ ê²€ì‚¬: ê³¼ê±°(ì˜¤ëŠ˜ ì´ì „) + (ì˜µì…˜)ì‹œì‘ì¼ ì´í›„ ë²”ìœ„ì—ì„œ ë¹ˆì¹¸/â¬œ/ğŸŸª â‡’ âŒ
            let changed = false;
            const rowRe = /^\s*\|\s*(\d{4}-\d{2}-\d{2})\s*\|\s*([^|]*)\|\s*(.*)\|?\s*$/;

            const newLines = lines.map(line => {
              const m = line.match(rowRe);
              if (!m) return line; // í‘œ í˜•ì‹ ì•„ë‹ˆë©´ ê±´ë“œë¦¬ì§€ ì•ŠìŒ
              const [, dateStr, statusRaw, restRaw] = m;
              const rowDate = toDate(dateStr);

              // ë¯¸ë˜/ì˜¤ëŠ˜ì€ ìŠ¤í‚µ, ê³¼ê±°ë§Œ ë§ˆê°
              if (!(rowDate < today)) return line;
              if (hasStartFloor && rowDate < startFloor) return line;

              const status = statusRaw.trim();
              const rest = (restRaw || '').replace(/\|+\s*$/, '').trim();

              if (isEmpty(status)) {
                changed = true;
                return `| ${dateStr} | âŒ | ${rest} |`;
              }
              return line;
            });

            if (!changed) {
              core.info('No past blanks to close.'); 
            } else {
              // í•­ìƒ í‘œ ì „ì²´(í—¤ë”+êµ¬ë¶„ì„ +ë°ì´í„°)ë¥¼ ë§ˆì»¤ ë¸”ë¡ ì•ˆì— í†µì§¸ë¡œ ì‘ì„±
              const header = '| Date       | Status | Note |\n|------------|--------|------|';
              block = '\n' + header + '\n' + newLines.join('\n') + '\n';
              const out = before + block + after;
              fs.writeFileSync(path, out, 'utf8');
              core.info('Closed past blanks as âŒ (including ğŸŸª).');
            }

      - name: Create PR to develop
        if: success()
        uses: peter-evans/create-pull-request@v6
        with:
          base: develop
          branch: automation/daily-close
          title: "chore: daily close (mark past blanks as âŒ)"
          commit-message: "chore: daily close (mark past blanks as âŒ)"
          add-paths: |
            ${{ env.README_PATH }}

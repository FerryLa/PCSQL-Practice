name: Daily Close (mark ‚ùå for missing)

on:
  schedule:
    - cron: '5 15 * * *'   # Îß§Ïùº 00:05 KST
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  close:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
      START_DATE: '2025-10-02'
      END_DATE: '2025-11-21'
      README_PATH: 01_cert_week_7/README.md
    steps:
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: refs/heads/develop

      - name: Mark ‚ùå for yesterday if empty
        uses: actions/github-script@v7
        env:
          README_PATH: 01_cert_week_7/README.md
        with:
          script: |
            const fs = require('fs');
            const path=process.env.README_PATH;
            if (!fs.existsSync(path)) { core.setFailed(`README not found: ${path}`); return; }
            let md = fs.readFileSync(path,'utf8');
            const S='<!-- PROGRESS:START -->', E='<!-- PROGRESS:END -->';
            const si=md.indexOf(S), ei=md.indexOf(E);
            if (si<0||ei<0){ core.setFailed('Markers missing'); return; }

            const before=md.slice(0,si+S.length), after=md.slice(ei);
            const lines=md.slice(si+S.length,ei).split('\n');

            const isEmpty = s => ['','‚¨ú','üü™'].includes(String(s).trim());

            const nowKST = new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Seoul'}));
            nowKST.setDate(nowKST.getDate()-1); // Ïñ¥Ï†ú
            const z=n=>String(n).padStart(2,'0');
            const date=`${nowKST.getFullYear()}-${z(nowKST.getMonth()+1)}-${z(nowKST.getDate())}`;

            let idx = -1;
            for (let i=0;i<lines.length;i++){
              const m = lines[i].match(/^\s*\|\s*(\d{4}-\d{2}-\d{2})\s*\|\s*([^|]*)\|\s*(.*)\|?\s*$/);
              if (m && m[1]===date){ idx=i; break; }
            }

            if (idx>=0){
              const m = lines[idx].match(/^\s*\|\s*(\d{4}-\d{2}-\d{2})\s*\|\s*([^|]*)\|\s*(.*)\|?\s*$/);
              const status=m[2], rest=m[3];
              if (isEmpty(status)) lines[idx]=`| ${date} | ‚ùå | ${rest} |`; else { core.info('Already marked.'); return; }
            } else {
              // Ìó§Îçî ÏïÑÎûò ÏÉà Ìñâ Ï∂îÍ∞Ä
              let insertAt = 0;
              for (let i=0;i<lines.length;i++){
                if (/^\s*\|\s*Date\s*\|\s*Status\s*\|\s*Note/.test(lines[i])) { insertAt = i+1; break; }
              }
              lines.splice(insertAt, 0, `| ${date} | ‚ùå | |`);
            }

            const out = before+'\n'+lines.join('\n').replace(/^\n+/, '')+after;
            fs.writeFileSync(path,out,'utf8');
            core.info(`Closed ${date} with ‚ùå`);
      

      - name: PR to develop
        uses: peter-evans/create-pull-request@v6
        with:
          base: develop
          branch: automation/daily-close
          title: "chore: daily close (mark ‚ùå)"
          commit-message: "chore: daily close (mark ‚ùå)"
          add-paths: |
            ${{ env.README_PATH }}

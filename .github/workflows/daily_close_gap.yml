# .github/workflows/daily_close_gap.yml
name: Daily Close (mark âŒ for missing)

on:
  schedule:
    - cron: '5 15 * * *'   # ë§¤ì¼ 00:05 KST (UTC+9 â†’ 15:05 UTC)
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  close:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
      # ë¦¬ë“œë¯¸ ê²½ë¡œ(í”„ë¡œì íŠ¸ì— ë§ê²Œ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ê²½ë¡œë¥¼ ìœ ì§€í•˜ì„¸ìš”)
      README_PATH: 01_cert_week_7/README.md
    steps:
      # developì˜ ìµœì‹  ìŠ¤ëƒ…ìƒ·ì„ ì²´í¬ì•„ì›ƒ
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: refs/heads/develop

      # ì–´ì œ ë‚ ì§œ í–‰ì´ ë¹„ì—ˆê±°ë‚˜(ë¹ˆ/â¬œ/ğŸŸª) ì—†ìœ¼ë©´ âŒë¡œ ê¸°ë¡
      - name: Mark âŒ for yesterday if empty
        uses: actions/github-script@v7
        env:
          README_PATH: ${{ env.README_PATH }}
        with:
          script: |
            const fs = require('fs');  // core, github, context ì „ì—­ ì œê³µ
            const path = process.env.README_PATH;

            // 0) íŒŒì¼/ë§ˆì»¤ í™•ì¸
            if (!fs.existsSync(path)) { core.warning(`Skip: ${path} not found`); return; }
            let md = fs.readFileSync(path, 'utf8');
            const S='<!-- PROGRESS:START -->', E='<!-- PROGRESS:END -->';
            const si=md.indexOf(S), ei=md.indexOf(E);
            if (si<0 || ei<0) { core.warning(`Skip: progress markers missing in ${path}`); return; }

            // 1) ì–´ì œ(KST) ê³„ì‚°
            const nowKST = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
            const z = n => String(n).padStart(2, '0');
            const yObj = new Date(nowKST); yObj.setDate(yObj.getDate()-1);
            const ymd = `${yObj.getFullYear()}-${z(yObj.getMonth()+1)}-${z(yObj.getDate())}`;

            // 2) ë¸”ë¡ë§Œ ìˆ˜ì •
            const before = md.slice(0, si + S.length);
            let   block  = md.slice(si + S.length, ei);
            const after  = md.slice(ei);

            const lines = block.split('\n');
            const isEmpty = s => ['','â¬œ','ğŸŸª'].includes(String(s).trim());

            // í‘œì˜ í–‰ ì¸ë±ìŠ¤ ë§µ(date â†’ index)
            const rowIdx = new Map();
            lines.forEach((line, i) => {
              const m = line.match(/^\s*\|\s*(\d{4}-\d{2}-\d{2})\s*\|\s*([^|]*)\|\s*(.*)\|?\s*$/);
              if (m) rowIdx.set(m[1], i);
            });

            let changed = false;

            if (rowIdx.has(ymd)) {
              // ê¸°ì¡´ í–‰ì´ ìˆìœ¼ë©´ ìƒíƒœê°€ ë¹„ì—ˆì„ ë•Œë§Œ âŒë¡œ ë³€ê²½
              const i = rowIdx.get(ymd);
              const m = lines[i].match(/^\s*\|\s*(\d{4}-\d{2}-\d{2})\s*\|\s*([^|]*)\|\s*(.*)\|?\s*$/);
              if (!m) { core.info('Row parse failed. Skip.'); return; }
              const status = m[2];
              const rest   = m[3];
              if (isEmpty(status)) {
                lines[i] = `| ${ymd} | âŒ | ${rest} |`;
                changed = true;
              }
            } else {
              // ì–´ì œ í–‰ì´ ì—†ìœ¼ë©´ í—¤ë” ë°”ë¡œ ì•„ë˜ì— ìƒˆ í–‰ ì¶”ê°€
              let insertAt = 0;
              for (let i=0;i<lines.length;i++){
                if (/^\s*\|\s*Date\s*\|\s*Status\s*\|\s*Note/.test(lines[i])) { insertAt = i+1; break; }
              }
              lines.splice(insertAt, 0, `| ${ymd} | âŒ | |`);
              changed = true;
            }

            if (!changed) { core.info('No daily-close change needed.'); return; }

            block = lines.join('\n');
            const out = before + '\n' + block.replace(/^\n+/, '') + after;
            fs.writeFileSync(path, out, 'utf8');
            core.info(`Daily-close marked âŒ for ${ymd}`);

      # ë³€ê²½ì‚¬í•­ì„ PRë¡œ ì˜¬ë¦°ë‹¤(ë³´í˜¸ ë¸Œëœì¹˜ì— ì§ì ‘ í‘¸ì‹œ ê¸ˆì§€ ê°€ì •)
      - name: PR to develop
        uses: peter-evans/create-pull-request@v6
        with:
          base: develop
          branch: automation/daily-close
          title: "chore: daily close (mark âŒ)"
          commit-message: "chore: daily close (mark âŒ)"
          add-paths: |
            ${{ env.README_PATH }}
